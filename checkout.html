<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Dapur Kana</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #00cfd3;
    }

    header {
      background: #004d4d;
      color: white;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .hamburger {
      font-size: 24px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    .title {
      font-size: 20px;
      font-weight: bold;
    }

    .icons a {
      color: white;
      text-decoration: none;
      margin-left: 12px;
    }

    main {
      padding: 16px;
      color: white;
    }

    form input, form textarea, form select {
      width: 100%;
      margin-bottom: 12px;
      padding: 10px;
      border: none;
      border-radius: 8px;
    }

    form button {
      background: #004d4d;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .keranjang-item {
      background: white;
      color: black;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    #totalHarga {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <button class="hamburger" onclick="openSidebar()">‚ò∞</button>
  <div class="title">Checkout</div>
  <div class="icons">
    <a href="notifikasi.html">üîî</a>
  </div>
</header>

<!-- Sidebar -->
<div id="sidebar" style="position: fixed; left: -250px; top: 0; width: 250px; height: 100%; background: #003333; z-index: 1000; padding-top: 60px; transition: 0.3s;">
  <a href="index.html" style="color:white; display:block; padding:10px 20px;">üè† Beranda</a>
  <a href="menu.html" style="color:white; display:block; padding:10px 20px;">üçΩÔ∏è Menu</a>
  <a href="checkout.html" style="color:white; display:block; padding:10px 20px;">üõí Keranjang</a>
  <a href="notifikasi.html" style="color:white; display:block; padding:10px 20px;">üîî Notifikasi</a>
</div>
<div id="overlay" onclick="closeSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index:999;"></div>

<main>
  <h2>Keranjang Anda</h2>
  <div id="keranjangList">Memuat...</div>
  <p id="totalHarga"></p>

  <h3>Isi Data Pemesan</h3>
  <form id="checkoutForm">
    <input type="text" id="nama" placeholder="Nama Anda" required />
    <input type="text" id="no_hp" placeholder="No. HP" required />
    <textarea id="alamat" placeholder="Alamat Lengkap" required></textarea>
    <select id="pembayaran" required>
      <option value="">Pilih Metode Pembayaran</option>
      <option value="COD">COD</option>
      <option value="Transfer">Transfer</option>
    </select>
    <button type="submit">Kirim Pesanan</button>
  </form>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const supabase = createClient(
    "https://qcevidnjbsyjfdwfduiz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjZXZpZG5qYnN5amZkd2ZkdWl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzcwODksImV4cCI6MjA2ODYxMzA4OX0.bR-FZBvVbY7njHKvI_lA0GPs4TaHQKq8YzX2a-dJ3JI"
  );

  const keranjangList = document.getElementById("keranjangList");
  const totalHargaEl = document.getElementById("totalHarga");

  let currentCheckoutId = null;

  async function loadDraftCheckout() {
    const { data, error } = await supabase
      .from("checkout")
      .select("*")
      .eq("status", "draft")
      .maybeSingle();

    if (error || !data) {
      keranjangList.innerHTML = "Keranjang kosong.";
      return;
    }

    currentCheckoutId = data.id;

    const items = JSON.parse(data.item || "[]");
    if (items.length === 0) {
      keranjangList.innerHTML = "Keranjang kosong.";
    } else {
      keranjangList.innerHTML = "";
      let total = 0;
      items.forEach(item => {
        total += item.harga * item.qty;
        keranjangList.innerHTML += `
          <div class="keranjang-item">
            <strong>${item.nama}</strong><br/>
            Qty: ${item.qty} x Rp${item.harga.toLocaleString()} = Rp${(item.qty * item.harga).toLocaleString()}
          </div>
        `;
      });
      totalHargaEl.textContent = "Total: Rp" + total.toLocaleString();
    }
  }

  document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nama = document.getElementById("nama").value;
    const no_hp = document.getElementById("no_hp").value;
    const alamat = document.getElementById("alamat").value;
    const pembayaran = document.getElementById("pembayaran").value;

    if (!currentCheckoutId) {
      alert("Tidak ada data checkout yang bisa dikirim.");
      return;
    }

    const { error } = await supabase
      .from("checkout")
      .update({
        nama,
        no_hp,
        alamat,
        pembayaran,
        status: "menunggu"
      })
      .eq("id", currentCheckoutId);

    if (error) {
      alert("Gagal mengirim pesanan.");
    } else {
      alert("Pesanan berhasil dikirim!");
      window.location.href = "notifikasi.html";
    }
  });

  window.openSidebar = () => {
    document.getElementById("sidebar").style.left = "0";
    document.getElementById("overlay").style.display = "block";
  }

  window.closeSidebar = () => {
    document.getElementById("sidebar").style.left = "-250px";
    document.getElementById("overlay").style.display = "none";
  }

  loadDraftCheckout();
</script>

</body>
</html>
