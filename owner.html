<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Owner - Dapur Kana</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Owner Page</h1>

  <section id="loginSection">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button id="loginBtn">Login</button>
  </section>

  <section id="dashboard" style="display:none;">
    <h2>Kelola Menu</h2>
    <form id="menuForm">
      <input type="hidden" id="menuId" />
      <input type="text" id="nama" placeholder="Nama Menu" required />
      <input type="number" id="harga" placeholder="Harga" required />
      <input type="text" id="kategori" placeholder="Kategori" required />
      <textarea id="deskripsi" placeholder="Deskripsi" required></textarea>
      <input type="file" id="gambar" accept="image/*" />
      <button type="submit">Simpan Menu</button>
    </form>

    <div id="menuList"></div>
    <button onclick="logout()">Logout</button>
  </section>

  <script>
    const supabase = supabase.createClient(
      'https://YOUR_PROJECT_ID.supabase.co',
      'YOUR_PUBLIC_ANON_KEY'
    );

    const loginSection = document.getElementById("loginSection");
    const dashboard = document.getElementById("dashboard");
    const menuList = document.getElementById("menuList");

    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        alert("Login gagal: " + error.message);
        return;
      }

      checkAuth();
    });

    async function checkAuth() {
      const { data } = await supabase.auth.getSession();
      const user = data.session?.user;

      if (user && user.email === "oishidzato@gmail.com") {
        loginSection.style.display = "none";
        dashboard.style.display = "block";
        loadMenu();
      } else {
        alert("Akses ditolak");
        await supabase.auth.signOut();
      }
    }

    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    async function loadMenu() {
      const { data, error } = await supabase.from("menu").select("*").order("nama", { ascending: true });
      menuList.innerHTML = "";

      if (error) {
        console.error("Gagal load menu:", error.message);
        return;
      }

      data.forEach(item => {
        const div = document.createElement("div");
        div.innerHTML = `
          <hr />
          <p><strong>${item.nama}</strong> (Rp ${item.harga})</p>
          ${item.gambar_url ? `<img src="${item.gambar_url}" width="100" />` : ""}
          <button onclick='editMenu(${JSON.stringify(item)})'>Edit</button>
          <button onclick='hapusMenu("${item.id}")'>Hapus</button>
        `;
        menuList.appendChild(div);
      });
    }

    window.editMenu = (item) => {
      document.getElementById("menuId").value = item.id;
      document.getElementById("nama").value = item.nama;
      document.getElementById("harga").value = item.harga;
      document.getElementById("kategori").value = item.kategori;
      document.getElementById("deskripsi").value = item.deskripsi;
    }

    window.hapusMenu = async (id) => {
      if (confirm("Hapus menu ini?")) {
        await supabase.from("menu").delete().eq("id", id);
        loadMenu();
      }
    }

    document.getElementById("menuForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("menuId").value;
      const nama = document.getElementById("nama").value;
      const harga = parseInt(document.getElementById("harga").value);
      const kategori = document.getElementById("kategori").value;
      const deskripsi = document.getElementById("deskripsi").value;
      const gambarFile = document.getElementById("gambar").files[0];

      let gambar_url = "";

      if (gambarFile) {
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from("gambar-menu")
          .upload(`menu/${Date.now()}_${gambarFile.name}`, gambarFile, {
            cacheControl: "3600",
            upsert: true,
          });

        if (uploadError) {
          alert("Gagal upload gambar: " + uploadError.message);
          return;
        }

        const { data: urlData } = supabase.storage
          .from("gambar-menu")
          .getPublicUrl(uploadData.path);
        gambar_url = urlData.publicUrl;
      }

      let result;

      if (id) {
        result = await supabase.from("menu").update({
          nama,
          harga,
          kategori,
          deskripsi,
          ...(gambar_url && { gambar_url })
        }).eq("id", id);
      } else {
        result = await supabase.from("menu").insert({
          nama,
          harga,
          kategori,
          deskripsi,
          gambar_url
        });
      }

      if (result.error) {
        alert("Gagal menyimpan data: " + result.error.message);
      } else {
        alert("Menu berhasil disimpan");
        document.getElementById("menuForm").reset();
        document.getElementById("menuId").value = "";
        loadMenu();
      }
    });

    checkAuth();
  </script>
</body>
</html>
