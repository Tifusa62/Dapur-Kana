<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Owner Panel - Dapur Kana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav>
  <a href="index.html">Beranda</a> |
  <a href="menu.html">Menu</a> |
  <a href="checkout.html">Keranjang</a> |
  <a href="notifikasi.html">Notifikasi</a> |
  <a href="owner.html">Owner</a>
</nav>

<header>
  <h1>👩‍🍳 Owner Panel</h1>
  <button id="logoutBtn">Logout</button>
</header>

<main>
  <section id="loginSection">
    <h2>Login Owner</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
  </section>

  <section id="dashboard" style="display:none;">
    <h2>Kelola Menu</h2>
    <form id="menuForm">
      <input type="hidden" id="menuId" />
      <input type="text" id="nama" placeholder="Nama Menu" required />
      <input type="number" id="harga" placeholder="Harga" required />
      <input type="text" id="kategori" placeholder="Kategori" required />
      <textarea id="deskripsi" placeholder="Deskripsi" required></textarea>
      <input type="file" id="gambar" accept="image/*" />
      <button type="submit">Simpan Menu</button>
    </form>

    <h3>Daftar Menu</h3>
    <div id="menuList"></div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  const supabaseUrl = 'https://qcevidnjbsyjfdwfduiz.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // gunakan yang asli
  const supabase = createClient(supabaseUrl, supabaseKey);

  const loginSection = document.getElementById("loginSection");
  const dashboard = document.getElementById("dashboard");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");

  const menuForm = document.getElementById("menuForm");
  const menuList = document.getElementById("menuList");

  loginBtn.onclick = async () => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: emailInput.value,
      password: passwordInput.value,
    });

    if (error) return alert("Login gagal: " + error.message);

    if (data.user.email !== "oishidzato@gmail.com") {
      await supabase.auth.signOut();
      return alert("Hanya pemilik yang bisa login!");
    }

    loginSection.style.display = "none";
    dashboard.style.display = "block";
    loadMenu();
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };

  menuForm.onsubmit = async (e) => {
    e.preventDefault();

    const id = document.getElementById("menuId").value;
    const nama = document.getElementById("nama").value;
    const harga = parseInt(document.getElementById("harga").value);
    const kategori = document.getElementById("kategori").value;
    const deskripsi = document.getElementById("deskripsi").value;
    const file = document.getElementById("gambar").files[0];
    let gambar_url = "";

    if (file) {
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}.${fileExt}`;
      const filePath = `menu/${fileName}`;

      const { error: uploadError } = await supabase.storage.from("gambar-menu").upload(filePath, file);
      if (uploadError) {
        alert("Upload gambar gagal: " + uploadError.message);
        return;
      }

      const { data: publicUrlData } = supabase.storage.from("gambar-menu").getPublicUrl(filePath);
      gambar_url = publicUrlData.publicUrl;
    }

    if (id) {
      await supabase.from("gambar-menu").update({
        nama, harga, kategori, deskripsi, ...(gambar_url && { gambar_url })
      }).eq("id", id);
    } else {
      await supabase.from("gambar-menu").insert({
        nama, harga, kategori, deskripsi, gambar_url
      });
    }

    menuForm.reset();
    document.getElementById("menuId").value = "";
    loadMenu();
  };

  async function loadMenu() {
    const { data, error } = await supabase.from("menu").select("*").order("nama", { ascending: true });
    menuList.innerHTML = "";

    if (error) {
      console.error("Gagal load menu:", error.message);
      return;
    }

    data.forEach(item => {
      const div = document.createElement("div");
      div.innerHTML = `
        <hr />
        <p><strong>${item.nama}</strong> (Rp ${item.harga})</p>
        ${item.gambar_url ? `<img src="${item.gambar_url}" width="100" />` : ""}
        <button onclick='editMenu(${JSON.stringify(item)})'>Edit</button>
        <button onclick='hapusMenu("${item.id}")'>Hapus</button>
      `;
      menuList.appendChild(div);
    });
  }

  window.editMenu = (item) => {
    document.getElementById("menuId").value = item.id;
    document.getElementById("nama").value = item.nama;
    document.getElementById("harga").value = item.harga;
    document.getElementById("kategori").value = item.kategori;
    document.getElementById("deskripsi").value = item.deskripsi;
  }

  window.hapusMenu = async (id) => {
    if (confirm("Hapus menu ini?")) {
      await supabase.from("menu").delete().eq("id", id);
      loadMenu();
    }
  }

  // Auto-login
  (async () => {
    const { data } = await supabase.auth.getSession();
    const user = data.session?.user;
    if (user && user.email === "oishidzato@gmail.com") {
      loginSection.style.display = "none";
      dashboard.style.display = "block";
      loadMenu();
    }
  })();
</script>

</body>
</html>
